// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© Selfsimilarity

//@version=6
indicator("Synapse Ouroboros Fatigue Guard [Layer 2]", overlay=false)

// =============================================================================
// ðŸ§  INLINED MODULE: DECAYING BAYESIAN WEIGHTING (DBW)
// =============================================================================
f_Synapse_dbw(float[] _outcomes, float _decay = 0.85) =>
    float weightSum = 0.0, float valueSum  = 0.0
    int size = array.size(_outcomes)
    if size > 0
        for i = 0 to size - 1
            float w = math.pow(_decay, size - i - 1)
            weightSum += w
            valueSum  += array.get(_outcomes, i) * w
    weightSum > 0 ? (valueSum / weightSum) * 100 : 50.0

// =============================================================================
// ðŸ›°ï¸ INPUTS & SWITCHBOARD
// =============================================================================
// --- ðŸ›°ï¸ INPUTS & SWITCHBOARD ---
group_feed = "Feedback Source"
srcExecBus = input.source(close, "Execution Bus (100.PB)", group=group_feed, tooltip="Connect to the 'Output: Universal Execution Bus' from the Execution Pulse script.")
srcOracle  = input.source(close, "Retail Shadow Oracle (200.PB)", group=group_feed, tooltip="Connect to the 'Output: Synapse Indicator Bus' from the Retail Shadow script.")

group_fatigue = "Fatigue Parameters"
densityWindow = input.int(20, "Density Lookback", minval=5, group=group_fatigue, tooltip="Number of bars to check for overtrading.")
maxDensity    = input.int(3, "Max Trades In Window", minval=1, group=group_fatigue)
drawdownThresh = input.float(15.0, "Velocity Threshold (%)", minval=1.0, group=group_fatigue, tooltip="Trigger if Win Rate drops by more than this in one bar.")
oracleDampen = input.bool(true, "Enable Oracle Pulse Dampening", group=group_fatigue, tooltip="If the Oracle detects a trap, force a dampened state.")

// Decoder for Execution Bus (100.PB)
f_unpack_exec(wire) =>
    val = wire - 100.0
    bool active = val >= 0 and val < 10.0
    resDigit = active ? math.floor(val * 10 + 0.5) % 10 : 0
    [resDigit == 1, resDigit == 2, resDigit == 3]

// Decoder for Oracle Bus (200.PB)
f_unpack_oracle(wire) =>
    val = wire - 200.0
    valid = val >= 0 and val < 100.0
    pDigit = valid ? math.floor(val * 10 + 0.5) % 10 : 0
    [pDigit == 1.0 or pDigit == 2.0] // 1:Cross Trap, 2:Gravity Trap

[eWin, eLose, eBE] = f_unpack_exec(srcExecBus)
[isOracleTrap]    = f_unpack_oracle(srcOracle)

// =============================================================================
// ðŸ›¡ï¸ LAYER 2 LOGIC: FATIGUE DETECTION
// =============================================================================
var float[] recentOutcomes = array.new_float(0)
var int tradeCount = 0

if eWin or eLose
    array.push(recentOutcomes, eWin ? 1.0 : 0.0)
    tradeCount += 1
    if array.size(recentOutcomes) > 10
        array.shift(recentOutcomes)

// 1. Drawdown Velocity
winRate = f_Synapse_dbw(recentOutcomes, 0.85)
float velocity = nz(winRate[1]) - winRate
bool isCrashing = velocity > drawdownThresh

// 2. Trade Density (Overtrading)
int tradesInWindow = 0
for i = 1 to densityWindow
    if (ta.change(srcExecBus[i]) != 0 and srcExecBus[i] > 100.0)
        tradesInWindow += 1
bool isDense = tradesInWindow > maxDensity

// 3. Oracle Sentiment Fatigue
bool isSentimentFatigue = oracleDampen and isOracleTrap

// ðŸ›¡ï¸ THE DAMPENER SIGNAL
// 0: Healthy, 1: Warming Up (Wary), 2: DAMPEN (High Fatigue)
float dampener = (isCrashing or isDense) ? 2.0 : (isSentimentFatigue or tradesInWindow > 1 ? 1.0 : 0.0)

// âž° TIER-3: ANTI-Synapse INVERSION
// If system efficacy < 35%, assume the market is perfectly counter-trending our signals.
bool antiSynapse = winRate < 35.0 and array.size(recentOutcomes) >= 5
float anti_digit = antiSynapse ? 1.0 : 0.0

// Visuals
col = dampener == 2.0 ? color.red : dampener == 1.0 ? color.orange : color.lime
plot(winRate, "Feedback Win Rate", color=color.new(col, 80), style=plot.style_area)
plot(tradesInWindow, "Trade Density", color=color.blue, style=plot.style_linebr)
hline(maxDensity, "Density Limit", color=color.gray, linestyle=hline.style_dotted)

// Bus Output: Neural Dampener
// Format: 300 + (DampenerDigit * 0.1) + (AntiSynapseDigit * 0.01)
plot(300.0 + (dampener * 0.1) + (anti_digit * 0.01), "Output: Neural Dampener Bus", display=display.status_line + display.data_window)
