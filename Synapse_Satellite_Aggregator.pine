//@version=6
indicator("Synapse Satellite Aggregator [Template]", overlay=false)

// =============================================================================
// Synapse SATELLITE AGGREGATOR (Tier-2 Architecture)
// =============================================================================
// Use this template to aggregate 5-10 indicators of a specific category 
// (e.g., Order Flow, ML, Momentum) into a single Synapse Bus signal.
// =============================================================================

// --- SATELLITE INPUTS ---
group_sub = "1. Sub-Indicator Inputs"
src1 = input.source(close, "Sub-Indicator 1", group=group_sub)
src2 = input.source(close, "Sub-Indicator 2", group=group_sub)
src3 = input.source(close, "Sub-Indicator 3", group=group_sub)
src4 = input.source(close, "Sub-Indicator 4", group=group_sub)
src5 = input.source(close, "Sub-Indicator 5", group=group_sub)

group_weights = "2. Sub-Weighting"
w1 = input.float(1.0, "Weight 1", minval=0.0, group=group_weights)
w2 = input.float(1.0, "Weight 2", minval=0.0, group=group_weights)
w3 = input.float(1.0, "Weight 3", minval=0.0, group=group_weights)
w4 = input.float(1.0, "Weight 4", minval=0.0, group=group_weights)
w5 = input.float(1.0, "Weight 5", minval=0.0, group=group_weights)

group_bus = "3. Synapse Bus Configuration"
category_label = input.string("ORDERFLOW", "Category Label", group=group_bus)
slot_id = input.string("Slot A", "Target Master Slot", group=group_bus)

// --- AGGREGATION ENGINE ---
// Unpacks common 200.PB signals or simple bias sources
f_get_bias(_src) =>
    _bias = 0.0
    if _src >= 200.0 // It's a Synapse Bus signal
        val = _src - 200.0
        bDigit = math.floor(val * 100 + 0.5) % 10
        _bias := bDigit == 1 ? 1.0 : (bDigit == 2 ? -1.0 : 0.0)
    else // It's a standard bias source (-1 to 1)
        _bias := _src > 0 ? 1.0 : (_src < 0 ? -1.0 : 0.0)
    _bias

b1 = f_get_bias(src1), b2 = f_get_bias(src2), b3 = f_get_bias(src3), b4 = f_get_bias(src4), b5 = f_get_bias(src5)

// Weighted Consensus
float total_weight = w1 + w2 + w3 + w4 + w5
float weighted_sum = (b1 * w1) + (b2 * w2) + (b3 * w3) + (b4 * w4) + (b5 * w5)
float consensus = total_weight > 0 ? (weighted_sum / total_weight) : 0.0

// Thresholding
float threshold = 0.4 // 40% agreement required for a bias pulse
float final_bias = consensus >= threshold ? 1.0 : (consensus <= -threshold ? -1.0 : 0.0)
float final_pulse = math.abs(consensus) >= 0.8 ? 2.0 : (math.abs(consensus) >= 0.4 ? 1.0 : 0.0)

// --- ðŸšŒ Synapse UNIVERSAL BUS OUTPUT ---
// Pulse: 1:Category Agreement, 2:Unanimous
// Bias: 1:Long Verdict, 2:Short Verdict
float p_digit = final_pulse
float b_digit = final_bias == 1.0 ? 1.0 : (final_bias == -1.0 ? 2.0 : 0.0)

float Synapse_bus = 200.0 + (p_digit * 0.1) + (b_digit * 0.01)
plot(Synapse_bus, "Satellite Bus Output", display=display.status_line)

// --- SATELLITE HUD ---
var table sat_hud = table.new(position.bottom_right, 2, 8, bgcolor=color.new(color.black, 70), border_width=1)
if barstate.islast
    table.cell(sat_hud, 0, 0, category_label + " HUB", text_color=color.aqua)
    table.cell(sat_hud, 1, 0, final_bias == 1.0 ? "BULLISH" : (final_bias == -1.0 ? "BEARISH" : "NEUTRAL"), bgcolor=final_bias == 1.0 ? color.green : (final_bias == -1.0 ? color.red : color.gray), text_color=color.white)
    
    table.cell(sat_hud, 0, 1, "Consensus", text_color=color.white)
    table.cell(sat_hud, 1, 1, str.tostring(consensus * 100, "#.0") + "%", text_color=color.yellow)
    
    table.cell(sat_hud, 0, 2, "Bus Output", text_color=color.white)
    table.cell(sat_hud, 1, 2, str.tostring(Synapse_bus, "200.##"), text_color=color.yellow)
    
    table.cell(sat_hud, 0, 3, "Node Count", text_color=color.white)
    table.cell(sat_hud, 1, 3, "5 Active", text_color=color.white)
